<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Nom Nom - Delicious Treats">
    <meta name="keywords" content="cookies, brownies, lemonade, treats">
    <meta name="author" content="Nom Nom Team">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link rel="stylesheet" href="styles.css">
    <link rel="shortcut icon" href="logo-photoroom.png" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Relief:wght@400;700&display=swap" rel="stylesheet">
    <title>Menu | Nom Nom</title>
</head>
<body>
    <%- include('header') %>
    <main class="top">
        <section>
            <h1>Our Menu</h1>
        </section>
        <hr>
        <section>
            <% if (typeof success !== 'undefined' && success) { %>
                <div class="success-message">
                    Order placed successfully! We'll contact you soon.
                </div>
            <% } %>

            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% for (let i = 0; i < menu.length; i++) { %>
                        <% if (menu[i].visible) { %>
                            <tr>
                                <td><%= menu[i].name %></td>
                                <td>$<%= menu[i].price.toFixed(2) %></td>
                                <td>
                                    <% if (menu[i].stock === 0) { %>
                                        <span style="color: red; font-weight: bold;">Out of stock</span>
                                    <% } else if (menu[i].stock <= 10) { %>
                                        <span style="color: orange; font-weight: bold;">Only <%= menu[i].stock %> left!</span>
                                    <% } else { %>
                                        <span style="color: green;"><%= menu[i].stock %> available</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (menu[i].stock === 0) { %>
                                        <button disabled style="opacity: 0.5; cursor: not-allowed;">Out of Stock</button>
                                    <% } else { %>
                                        <button onclick="openOrderForm('<%= menu[i].name %>', <%= menu[i].price %>, <%= menu[i].stock %>)">Pre-Order</button>
                                    <% } %>
                                </td>
                            </tr>
                        <% } %>
                    <% } %>
                </tbody>
            </table>
        </section>

        <!-- Pre-order Form Modal -->
        <div id="orderModal" class="modal">
            <div class="modal-content">
                <span onclick="closeOrderForm()" class="modal-close">&times;</span>
                <h2>Pre-Order</h2>
                <form action="/pre-order" method="POST">
                    <div class="form-group">
                        <label for="item">Item:</label>
                        <input type="text" id="item" name="item" readonly>
                    </div>

                    <div class="form-group">
                        <label for="quantity">Quantity:</label>
                        <input type="number" id="quantity" name="quantity" min="1" max="10" value="1" required>
                    </div>

                    <div class="form-group">
                        <label for="customerName">Your Name:</label>
                        <input
                            type="text"
                            id="customerName"
                            name="customerName"
                            required
                            placeholder="John Cena"
                        >
                    </div>

                    <div class="form-group">
                        <label for="customerEmail">Your Email:</label>
                        <input
                            type="email"
                            id="customerEmail"
                            name="customerEmail"
                            required
                            pattern="^[a-zA-Z0-9._%+-]+@hbhs\.school\.nz$"
                            placeholder="4jcena@hbhs.school.nz"
                            oninvalid="this.setCustomValidity('Please use your school email ending with @hbhs.school.nz')"
                            oninput="this.setCustomValidity('')"
                        />
                        <div id="emailError" class="error-message" style="display:none; background: rgba(248,215,218,0.95); color:#721c24; border-color:#f5c6cb; margin-top:8px; padding:8px; font-weight:600;">
                            <!-- JS will fill this -->
                        </div>
                    </div>

                    <div class="form-total">
                        <strong>Total: $<span id="totalPrice">0.00</span></strong>
                    </div>

                    <div class="form-buttons">
                        <button type="submit">Place Pre-Order</button>
                        <button type="button" onclick="closeOrderForm()" class="cancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <style>
          /* small additions â€” move to styles.css if you want permanent styling */
          input.valid { border-color: #28a745 !important; box-shadow: 0 0 6px rgba(40,167,69,0.18); }
          input.invalid { border-color: #dc3545 !important; box-shadow: 0 0 6px rgba(220,53,69,0.18); }
          #preOrderSubmit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        </style>

        <!-- Extra script: email validation -->
        <script>
        (function() {
          const form = document.querySelector('form[action="/pre-order"]'); // safer than id
          const emailInput = document.getElementById('customerEmail');
          const emailError = document.getElementById('emailError');

          const allowedRegex = /^[a-zA-Z0-9._%+-]+@hbhs\.school\.nz$/i;

          function validateEmail() {
            const val = (emailInput.value || '').trim();
            return allowedRegex.test(val);
          }

          form.addEventListener('submit', function(e) {
            if (!validateEmail()) {
              e.preventDefault();           // stop normal submit
              e.stopImmediatePropagation(); // stop anything else
              emailError.textContent = 'Please use your school email ending with @hbhs.school.nz';
              emailError.style.display = 'block';
              emailInput.classList.add('invalid');
              emailInput.focus();
            }
          });
        })();
        </script>


        <script>
            let currentPrice = 0;

            function openOrderForm(itemName, price, stock) {
                document.getElementById('item').value = itemName;
                currentPrice = price;
                // Update max quantity based on stock
                const quantityInput = document.getElementById('quantity');
                quantityInput.max = Math.min(10, stock);
                quantityInput.value = 1;
                updateTotal();
                document.getElementById('orderModal').style.display = 'block';
            }

            function closeOrderForm() {
                document.getElementById('orderModal').style.display = 'none';
            }

            function updateTotal() {
                const quantity = document.getElementById('quantity').value || 1;
                const total = (currentPrice * quantity).toFixed(2);
                document.getElementById('totalPrice').textContent = total;
            }

            document.getElementById('quantity').addEventListener('input', updateTotal);

            // Close modal when clicking outside of it
            window.onclick = function(event) {
                const modal = document.getElementById('orderModal');
                if (event.target == modal) {
                    closeOrderForm();
                }
            }
        </script>
    </main>


    <script>
        alert("This is a BETA feature...")
        alert("All orders will be reset after 15 minutes. For your proper order, wait until Week 1 of Term 4.")
    </script>
</body>
</html>
