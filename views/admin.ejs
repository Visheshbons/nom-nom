<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Nom Nom - Delicious Treats">
    <meta name="keywords" content="cookies, brownies, lemonade, treats">
    <meta name="author" content="Nom Nom Team">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link rel="stylesheet" href="styles.css">
    <link rel="shortcut icon" href="logo-photoroom.png" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Relief:wght@400;700&display=swap" rel="stylesheet">
    <title>ADMIN | Nom Nom</title>
</head>
<body>
    <%- include('header') %>
    <main class="admin-main top">
        <div class="admin-header">
            <h1>Admin Dashboard</h1>
            <a href="/admin/logout" class="logout-btn">Logout</a>
        </div>

        <!-- Statistics Cards -->
        <section class="stats-section">
            <div class="stat-card">
                <h3>Total Orders</h3>
                <p class="stat-number"><%= stats.totalOrders %></p>
            </div>
            <div class="stat-card">
                <h3>Pending Orders</h3>
                <p class="stat-number pending"><%= stats.pendingOrders %></p>
            </div>
            <div class="stat-card">
                <h3>Completed Orders</h3>
                <p class="stat-number completed"><%= stats.completedOrders %></p>
            </div>
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <p class="stat-number revenue">$<%= stats.totalRevenue.toFixed(2) %></p>
            </div>
        </section>

        <hr>

        <section class="orders-section">
            <h2>Manage Orders</h2>

            <% if (orders.length === 0) { %>
                <div class="empty-state">
                    <p>No orders found.</p>
                </div>
            <% } else { %>
                <!-- Desktop Table View -->
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer Name</th>
                                <th>Email</th>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% for (let i = 0; i < orders.length; i++) { %>
                                <tr data-order-id="<%= orders[i].id %>">
                                    <td>#<%= orders[i].id %></td>
                                    <td><%= orders[i].customerName %></td>
                                    <td><%= orders[i].customerEmail %></td>
                                    <td><%= orders[i].item %></td>
                                    <td><%= orders[i].quantity %></td>
                                    <td>$<%= orders[i].total.toFixed(2) %></td>
                                    <td>
                                        <span class="status-badge status-<%= orders[i].status %>">
                                            <%= orders[i].status.charAt(0).toUpperCase() + orders[i].status.slice(1) %>
                                        </span>
                                    </td>
                                    <td><%= new Date(orders[i].timestamp).toLocaleDateString() %></td>
                                    <td class="action-buttons">
                                        <div class="action-row">
                                            <select onchange="updateOrderStatus(<%= orders[i].id %>, this.value)" class="status-select">
                                                <option value="pending" <%= orders[i].status === 'pending' ? 'selected' : '' %>>Pending</option>
                                                <option value="preparing" <%= orders[i].status === 'preparing' ? 'selected' : '' %>>Preparing</option>
                                                <option value="ready" <%= orders[i].status === 'ready' ? 'selected' : '' %>>Ready</option>
                                                <option value="completed" <%= orders[i].status === 'completed' ? 'selected' : '' %>>Completed</option>
                                                <option value="cancelled" <%= orders[i].status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                                            </select>
                                        </div>
                                        <div class="action-row">
                                            <button onclick="viewOrderDetails(<%= orders[i].id %>)" class="btn-view">View</button>
                                            <button onclick="deleteOrder(<%= orders[i].id %>)" class="btn-delete">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Card View -->
                <div class="mobile-orders">
                    <% for (let i = 0; i < orders.length; i++) { %>
                        <div class="order-card" data-order-id="<%= orders[i].id %>">
                            <div class="order-card-header">
                                <span class="order-id">#<%= orders[i].id %></span>
                                <span class="status-badge status-<%= orders[i].status %>">
                                    <%= orders[i].status.charAt(0).toUpperCase() + orders[i].status.slice(1) %>
                                </span>
                            </div>

                            <div class="order-card-body">
                                <div class="order-field">
                                    <span class="order-field-label">Customer</span>
                                    <span class="order-field-value"><%= orders[i].customerName %></span>
                                </div>
                                <div class="order-field">
                                    <span class="order-field-label">Email</span>
                                    <span class="order-field-value"><%= orders[i].customerEmail %></span>
                                </div>
                                <div class="order-field">
                                    <span class="order-field-label">Item</span>
                                    <span class="order-field-value"><%= orders[i].item %></span>
                                </div>
                                <div class="order-field">
                                    <span class="order-field-label">Quantity</span>
                                    <span class="order-field-value"><%= orders[i].quantity %></span>
                                </div>
                                <div class="order-field">
                                    <span class="order-field-label">Total</span>
                                    <span class="order-field-value">$<%= orders[i].total.toFixed(2) %></span>
                                </div>
                                <div class="order-field">
                                    <span class="order-field-label">Date</span>
                                    <span class="order-field-value"><%= new Date(orders[i].timestamp).toLocaleDateString() %></span>
                                </div>
                            </div>

                            <div class="order-card-actions">
                                <div class="mobile-action-row">
                                    <select onchange="updateOrderStatus(<%= orders[i].id %>, this.value)" class="mobile-status-select">
                                        <option value="pending" <%= orders[i].status === 'pending' ? 'selected' : '' %>>Pending</option>
                                        <option value="preparing" <%= orders[i].status === 'preparing' ? 'selected' : '' %>>Preparing</option>
                                        <option value="ready" <%= orders[i].status === 'ready' ? 'selected' : '' %>>Ready</option>
                                        <option value="completed" <%= orders[i].status === 'completed' ? 'selected' : '' %>>Completed</option>
                                        <option value="cancelled" <%= orders[i].status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                                    </select>
                                </div>
                                <div class="mobile-action-row">
                                    <button onclick="viewOrderDetails(<%= orders[i].id %>)" class="mobile-btn mobile-btn-view">View Details</button>
                                    <button onclick="deleteOrder(<%= orders[i].id %>)" class="mobile-btn mobile-btn-delete">Delete</button>
                                </div>
                            </div>
                        </div>
                    <% } %>
                </div>
            <% } %>
        </section>

        <!-- Order Details Modal -->
        <div id="orderDetailsModal" class="modal">
            <div class="modal-content">
                <span onclick="closeOrderDetails()" class="modal-close">&times;</span>
                <h2>Order Details</h2>
                <div id="orderDetailsContent">
                    <!-- Order details will be loaded here -->
                </div>
            </div>
        </div>

        <script>
            function updateOrderStatus(orderId, newStatus) {
                fetch(`/admin/orders/${orderId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `status=${encodeURIComponent(newStatus)}`
                })
                .then(response => {
                    if (response.ok) {
                        // Update the status badge in table view
                        const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
                        if (row) {
                            const statusBadge = row.querySelector('.status-badge');
                            statusBadge.className = `status-badge status-${newStatus}`;
                            statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                        }

                        // Update the status badge in card view
                        const card = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
                        if (card) {
                            const statusBadge = card.querySelector('.status-badge');
                            statusBadge.className = `status-badge status-${newStatus}`;
                            statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                        }

                        // Refresh page to update statistics
                        setTimeout(() => location.reload(), 500);
                    } else {
                        alert('Failed to update order status');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update order status');
                });
            }

            function deleteOrder(orderId) {
                if (confirm('Are you sure you want to delete this order?')) {
                    fetch(`/admin/orders/${orderId}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove the row from the table
                            const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
                            if (row) row.remove();

                            // Remove the card from mobile view
                            const card = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
                            if (card) card.remove();

                            // Refresh page to update statistics
                            setTimeout(() => location.reload(), 500);
                        } else {
                            alert('Failed to delete order');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete order');
                    });
                }
            }

            function viewOrderDetails(orderId) {
                fetch(`/admin/orders/${orderId}`)
                    .then(response => response.json())
                    .then(order => {
                        const content = `
                            <div class="order-detail">
                                <h3>Order #${order.id}</h3>
                                <p><strong>Customer:</strong> ${order.customerName}</p>
                                <p><strong>Email:</strong> ${order.customerEmail}</p>
                                <p><strong>Item:</strong> ${order.item}</p>
                                <p><strong>Quantity:</strong> ${order.quantity}</p>
                                <p><strong>Unit Price:</strong> $${order.price.toFixed(2)}</p>
                                <p><strong>Total:</strong> $${order.total.toFixed(2)}</p>
                                <p><strong>Status:</strong> <span class="status-badge status-${order.status}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span></p>
                                <p><strong>Order Date:</strong> ${new Date(order.timestamp).toLocaleString()}</p>
                            </div>
                        `;
                        document.getElementById('orderDetailsContent').innerHTML = content;
                        document.getElementById('orderDetailsModal').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to load order details');
                    });
            }

            function closeOrderDetails() {
                document.getElementById('orderDetailsModal').style.display = 'none';
            }

            // Close modal when clicking outside of it
            window.onclick = function(event) {
                const modal = document.getElementById('orderDetailsModal');
                if (event.target == modal) {
                    closeOrderDetails();
                }
            }
        </script>
    </main>
</body>
</html>
